extends layout

block content
	main.container.py-4
		.row.justify-content-center
			.col-12.col-lg-10.col-xl-8
				//- Page header
				.page-header
					div
						h1 JogFile
						.date= todayFormatted
					.d-flex.align-items-center.gap-2
						a.btn.btn-birthday.btn-sm(href="/birthdays")
							span ðŸŽ‚
							span.d-none.d-sm-inline  Birthdays
						a.btn.btn-recurring.btn-sm(href="/recurring")
							span â†»
							span.d-none.d-sm-inline  Recurring
						button.btn.btn-primary.btn-sm(type="button" data-bs-toggle="collapse" data-bs-target="#addTaskForm" aria-expanded="false" aria-controls="addTaskForm")
							span +
							span.d-none.d-sm-inline  Add

				//- Upcoming birthdays widget
				if upcomingBirthdays && upcomingBirthdays.length > 0
					.upcoming-birthdays.mb-4
						.upcoming-birthdays-header
							span ðŸŽ‚
							span Upcoming Birthdays
						each item in upcomingBirthdays
							.upcoming-birthday-item(class=item.isToday ? 'upcoming-birthday-today' : '')
								if item.isToday
									span.text-danger Today: #{item.person.name}
									if item.turningAge
										span.birthday-age  (#{item.turningAge})
								else if item.daysUntil === 1
									span Tomorrow: #{item.person.name}
									if item.turningAge
										span.text-muted  (turning #{item.turningAge})
								else
									span= item.person.name
									span.text-muted  in #{item.daysUntil} days
									if item.turningAge
										span.text-muted  (turning #{item.turningAge})

				//- Add task form (collapsible)
				#addTaskForm.collapse.mb-4
					.add-task-card
						form(method="POST" action="/tasks")
							.d-flex.gap-2
								input#addTaskInput.form-control.flex-grow-1(type="text" name="title" placeholder="What needs to be done?" required autocomplete="off")
								button.btn.btn-primary(type="submit") Add
							.destination-selector
								label.destination-option
									input(type="radio" name="destination" value="today" checked)
									span Today
								label.destination-option
									input#destDate(type="radio" name="destination" value="date")
									span Schedule:
									input#scheduledForDate.form-control.form-control-sm(type="date" name="scheduledFor" style="width: auto; margin-left: 0.25rem")
								label.destination-option
									input(type="radio" name="destination" value="scratch")
									span Scratch Pad

				script.
					// Auto-select "Schedule" radio when date picker is interacted with
					const dateInput = document.getElementById('scheduledForDate');
					const dateRadio = document.getElementById('destDate');
					if (dateInput && dateRadio) {
						dateInput.addEventListener('focus', () => dateRadio.checked = true);
						dateInput.addEventListener('click', () => dateRadio.checked = true);
					}
					// Focus the input when the form is shown
					const addTaskForm = document.getElementById('addTaskForm');
					const addTaskInput = document.getElementById('addTaskInput');
					if (addTaskForm && addTaskInput) {
						addTaskForm.addEventListener('shown.bs.collapse', () => addTaskInput.focus());
					}

				//- Today's tasks
				if tasks.length === 0
					.empty-state
						.empty-state-icon âœ“
						p All clear for today
				else
					.task-list.mb-4
						each task in tasks
							include task

				.section-divider

				//- Tomorrow section
				- var tomorrowTotal = tomorrowTasks.length + (tomorrowRecurring ? tomorrowRecurring.length : 0)
				.mb-2
					.section-header(data-bs-toggle="collapse" data-bs-target="#tomorrowSection" aria-expanded="false")
						span.chevron â–¶
						span.section-title Tomorrow
						span.section-count= tomorrowTotal
					#tomorrowSection.collapse
						.px-4.py-2
							if tomorrowTotal === 0
								p.text-muted.small.mb-0 Nothing scheduled
							else
								each task in tomorrowTasks
									.task-preview.d-flex.align-items-center
										a(href=`/tasks/${task._id}/edit`)= task.title
								if tomorrowRecurring && tomorrowRecurring.length > 0
									each rec in tomorrowRecurring
										.task-preview.d-flex.align-items-center.task-preview-recurring
											a(href=`/recurring/${rec._id}/edit`)
												= rec.title
												span.task-source-indicator  â†»

				//- Next 7 days section
				- var upcomingTotal = upcomingTasks.length + (upcomingRecurring ? upcomingRecurring.length : 0)
				.mb-2
					.section-header(data-bs-toggle="collapse" data-bs-target="#upcomingSection" aria-expanded="false")
						span.chevron â–¶
						span.section-title Next 7 Days
						span.section-count= upcomingTotal
					#upcomingSection.collapse
						.px-4.py-2
							if upcomingTotal === 0
								p.text-muted.small.mb-0 Nothing scheduled
							else
								each task in upcomingTasks
									.task-preview
										a(href=`/tasks/${task._id}/edit`)= task.title
										.task-preview-date= formatDate(task.scheduledFor)
								if upcomingRecurring && upcomingRecurring.length > 0
									each rec in upcomingRecurring
										.task-preview.task-preview-recurring
											a(href=`/recurring/${rec._id}/edit`)
												= rec.title
												span.task-source-indicator  â†»
											.task-preview-date= formatDate(rec.scheduledFor)

				//- Later section
				.mb-2
					.section-header(data-bs-toggle="collapse" data-bs-target="#laterSection" aria-expanded="false")
						span.chevron â–¶
						span.section-title Later
						span.section-count= laterTasks.length
					#laterSection.collapse
						.px-4.py-2
							if laterTasks.length === 0
								p.text-muted.small.mb-0 Nothing scheduled
							else
								each task in laterTasks
									.task-preview
										a(href=`/tasks/${task._id}/edit`)= task.title
										.task-preview-date= formatDate(task.scheduledFor)

				.section-divider

				//- Scratch Pad section
				.mb-2
					.section-header(data-bs-toggle="collapse" data-bs-target="#scratchSection" aria-expanded="false")
						span.chevron â–¶
						span.section-title Scratch Pad
						span.section-count= scratchPadTasks.length
					#scratchSection.collapse
						.px-4.py-2
							if scratchPadTasks.length === 0
								p.text-muted.small.mb-0 No items
							else
								each task in scratchPadTasks
									.task-preview.d-flex.align-items-center
										a(href=`/tasks/${task._id}/edit`)= task.title

				//- Completed section
				.mb-2
					.section-header(data-bs-toggle="collapse" data-bs-target="#completedSection" aria-expanded="false")
						span.chevron â–¶
						span.section-title Completed
						span.section-count= completedTasks.length
					#completedSection.collapse
						.px-4.py-2
							if completedTasks.length === 0
								p.text-muted.small.mb-0 Nothing completed recently
							else
								each task in completedTasks
									.task-preview.d-flex.align-items-center.justify-content-between
										span.text-muted= task.title
										form(method="POST" action=`/tasks/${task._id}/restore` style="margin: 0")
											button.btn.btn-sm.btn-outline-secondary(type="submit") Restore
